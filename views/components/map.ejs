<%- include('../partials/commonheader') -%>


    <% if( locals.userType.includes('Admin')) { %>
        <%- include('../admin/navigation') -%>
            <% } else if(locals.userType.includes('Driver')) { %>
                <%- include('../driver/navigation') -%>
                    <% } else if(locals.userType.includes('User')) { %>
                        <%- include('../user/navigation') -%>
                            <% } %>

                                <style>
                                    #map {
                                        height: 400px;
                                        width: 100%;
                                    }

                                    h4 {
                                        display: inline;
                                    }

                                    .card-body {
                                        max-height: 600px;
                                        overflow: scroll;
                                    }

                                    .bus-container {
                                        display: flex;
                                        justify-content: center;
                                        padding: 12px;
                                        margin: 0 10px;
                                        background: #fff;
                                        border-radius: 24px;
                                    }

                                    .form {
                                        padding: 0;
                                    }

                                    h3 {
                                        display: flex;
                                        justify-content: space-between;
                                    }
                                </style>

                                <!-- Map Modal -->
                                <div class="modal fade" id="mapModal" tabindex="-1" aria-labelledby="mapModalLabel"
                                    aria-hidden="true">
                                    <div class="modal-dialog modal-lg">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="mapModalLabel">Map Modal</h5>
                                                <button type="button" class="close"
                                                    data-dismiss="modal">&times;</button>
                                            </div>
                                            <div class="modal-body">
                                                <!-- Replace the code below with your map integration code -->
                                                <div id="pathMap" style="height: 400px;"></div>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary"
                                                    data-dismiss="modal">Close</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Map Modal Ends -->



                                <div class="container">
                                    <div class="alert alert-primary" role="alert">
                                        <h2>Map View</h2>
                                    </div>
                                    <div class="row justify-content-center">
                                        <div id="map" class="col-lg-7 mt-2 card"></div>
                                        <div class="bus-container mt-2">
                                            <form class="form">
                                                <h3 class="title">View Buses
                                                    <div class="dropdown d-inline float-end">
                                                        <button class="btn btn-secondary dropdown-toggle" type="button"
                                                            id="dropdownMenuButton" data-toggle="dropdown"
                                                            aria-haspopup="true" aria-expanded="false">
                                                            <i class="fas fa-info-circle"></i>
                                                        </button>
                                                        <ul class="dropdown-menu dropdown-menu-end"
                                                            aria-labelledby="instructionsDropdown">
                                                            <li>
                                                                <h6 class="dropdown-header">Bus Status Colors:</h6>
                                                            </li>
                                                            <li>
                                                                <hr class="dropdown-divider">
                                                            </li>
                                                            <li><a class="dropdown-item" href="#">
                                                                    <span class="badge badge-primary">Ready or
                                                                        Live</span></a></li>
                                                            <li><a class="dropdown-item" href="#">
                                                                    <span class="badge bg-warning">In Traffic</span></a>
                                                            </li>
                                                            <li><a class="dropdown-item" href="#">
                                                                    <span class="badge bg-success">Arrived</span></a>
                                                            </li>
                                                            <li><a class="dropdown-item" href="#">
                                                                    <span class="badge bg-danger">Stop</span></a></li>
                                                        </ul>
                                                    </div>
                                                </h3>

                                                <!-- Search bar -->
                                                <label>
                                                    <input id="searchInput" required="" placeholder="" type="text"
                                                        class="input">
                                                    <span>Search for anything</span>
                                                </label>
                                                <!-- Search bar ends -->

                                                <div class="card-body">
                                                    <% busDetails.forEach((bus)=> { %>
                                                        <div class="form-group">
                                                            <h4><i class="fas fa-bus"></i>
                                                                <a href="/api/route-detail/<%= bus.bus_id %>">
                                                                    <%= bus.bus_name %>
                                                                </a>
                                                                <span class="pulse-icon <%= bus.status %>"></span>
                                                            </h4>
                                                            <ul>
                                                                <li>
                                                                    <a class="open-map-modal" href="#"
                                                                        id="open-modal-<%= bus.bus_id %>">
                                                                        <i class="las la-map-marked"> Open Map</i>
                                                                    </a>
                                                                </li>
                                                                <li><strong>Bus ID:</strong>
                                                                    <%= bus.bus_id %>
                                                                </li>
                                                                <li><strong>Bus Number:</strong>
                                                                    <%= bus.bus_number %>
                                                                </li>
                                                                <li><strong>Bus Model:</strong>
                                                                    <%= bus.bus_model %>
                                                                </li>
                                                                <li><strong>Bus Origin:</strong>
                                                                    <%= bus.bus_origin %>
                                                                </li>
                                                                <li><strong>Currently at:</strong>
                                                                    <span class="badge badge-success">
                                                                        <%= bus.current_stop %>
                                                                    </span>
                                                                </li>
                                                                <li><strong>Bus Destination:</strong>
                                                                    <%= bus.bus_destination %>
                                                                </li>
                                                            </ul>
                                                        </div>
                                                        <% }); %>
                                                </div>
                                            </form>
                                        </div>
                                    </div>



                                </div>


                                <script>
                                    function initMap() {
                                        var markers = []; // Store the markers on the map
                                        var map; // Declare the map variable

                                        // Replace the city names with your own cities
                                        const originCity = 'Mumbai';
                                        const destinationCity = 'Pune';

                                        // Create a map instance
                                        map = new google.maps.Map(document.getElementById('map'), {
                                            center: { lat: 0, lng: 0 }, // Set the initial map center
                                            zoom: 8 // Set the initial zoom level
                                        });

                                        // Create a directions service object
                                        const directionsService = new google.maps.DirectionsService();

                                        // Create a directions renderer object
                                        const directionsRenderer = new google.maps.DirectionsRenderer({
                                            map: map
                                        });

                                        // Define the request parameters for the directions service
                                        const request = {
                                            origin: originCity,
                                            destination: destinationCity,
                                            travelMode: google.maps.TravelMode.DRIVING // You can change the travel mode here
                                        };

                                        // Send the request to the directions service
                                        directionsService.route(request, function (response, status) {
                                            if (status === google.maps.DirectionsStatus.OK) {
                                                // Display the route on the map
                                                directionsRenderer.setDirections(response);
                                            } else {
                                                console.log('Error:', status);
                                            }
                                        });


                                        function updateBusLocations() {
                                            // Make an AJAX request to fetch the live bus locations from the server
                                            $.ajax({
                                                type: 'GET',
                                                url: '/api/get-live-status', // Replace with the actual server endpoint
                                                success: function (response) {
                                                    var busLocations = response.busLocations; // Extract the bus location data
                                                    var busDetails = response.busDetails; // Extract the bus details

                                                    // Update the bus locations on the map
                                                    busLocations.forEach(function (location) {
                                                        // Find an existing marker for the bus ID
                                                        var marker = markers.find(function (marker) {
                                                            return marker.busId === location.busId;
                                                        });

                                                        // If the marker doesn't exist, create a new one
                                                        if (!marker) {
                                                            marker = new google.maps.Marker({
                                                                busId: location.busId,
                                                                map: map,
                                                                title: 'Bus ' + location.busId,
                                                                icon: '/static/images/bus-icon.png'
                                                                // You can customize the marker icon here
                                                            });

                                                            // Determine the bus status (active or inactive)
                                                            var busStatus = location.isActive ? 'Active' : 'Inactive';
                                                            // Create an info window and set its content
                                                            var infoWindow = new google.maps.InfoWindow({
                                                                content: 'Bus ' + location.busId + '<br>Status: ' + busStatus
                                                            });

                                                            // Attach an event listener to the marker to open the info window on click
                                                            marker.addListener('click', function () {
                                                                infoWindow.open(map, marker);
                                                            });

                                                            markers.push(marker);
                                                        }

                                                        // Update the marker position
                                                        marker.setPosition({ lat: location.lat, lng: location.lng });
                                                    });

                                                    // Remove markers for buses that are no longer present
                                                    markers.forEach(function (marker) {
                                                        var isBusPresent = busLocations.some(function (location) {
                                                            return marker.busId === location.busId;
                                                        });
                                                        if (!isBusPresent) {
                                                            marker.setMap(null);
                                                        } else {
                                                            // Update the marker status based on the received bus location data
                                                            var location = busLocations.find(function (location) {
                                                                return marker.busId === location.busId;
                                                            });
                                                            var busStatus = location.isActive ? 'Active' : 'Inactive';
                                                            marker.setTitle('Bus ' + location.busId + ' - ' + busStatus);
                                                        }
                                                    });

                                                    // Update the bus details table
                                                    updateBusDetailsTable(busDetails);

                                                    // Center the map on the first bus location
                                                    if (busLocations.length > 0) {
                                                        map.setCenter({ lat: busLocations[0].lat, lng: busLocations[0].lng });
                                                    }
                                                },
                                                error: function (error) {
                                                    console.log('Error retrieving live bus locations:', error);
                                                }
                                            });
                                        }

                                        // Function to update the bus details table
                                        function updateBusDetailsTable(busDetails) {
                                            var tableBody = $('.card-body'); // Get the table body element

                                            // Clear the table body
                                            tableBody.empty();

                                            // Loop through the bus details and append rows to the table
                                            busDetails.forEach(function (bus) {
                                                var busStatusBadge = '<span class="pulse-icon ' + bus.status + '"></span>';
                                                // console.log(bus);

                                                // Create the table row
                                                var row = $('<div class="bus-details mb-3">').append(
                                                    $('<h4><i class="fas fa-bus"></i> <a href="/api/route-detail/' + bus.bus_id + '">' + bus.bus_name + '</a>' + busStatusBadge + '</h4>&nbsp;'),
                                                    $('<ul>').append(
                                                        $(`<li>
                                                                    <a class="open-map-modal" href="#" id="open-modal-${bus.bus_id}">
                                                                        <i class="las la-map-marked"> Open Map</i>
                                                                    </a>
                                                                </li>`),
                                                        $('<li><strong>Bus ID:</strong> ' + bus.bus_id + '</li>'),
                                                        $('<li><strong>Bus Number:</strong> ' + bus.bus_number + '</li>'),
                                                        $('<li><strong>Bus Model:</strong> ' + bus.bus_model + '</li>'),
                                                        $('<li class="origin-station"><strong>Bus Origin:</strong> ' + bus.bus_origin + '</li>'),
                                                        $(`<li data-lat='${bus.latitude}' data-lng='${bus.longitude}'><strong>Currently at:</strong>
                                                                <span class="badge badge-success">
                                                                    ${bus.current_stop}
                                                                </span>
                                                            </li>`),
                                                        $('<li><strong>Bus Destination:</strong> ' + bus.bus_destination + '</li>')
                                                    )
                                                );

                                                // Append the row to the table body
                                                tableBody.append(row);
                                            });
                                        }

                                        // Initialize the map with a default center
                                        map = new google.maps.Map(document.getElementById('map'), {
                                            zoom: 18,
                                            center: { lat: 37.7833, lng: -122.4167 },
                                            mapTypeId: google.maps.MapTypeId.ROADMAP
                                        });

                                        // Call updateBusLocations initially to populate the map with the latest bus locations and details
                                        updateBusLocations();

                                        // Update bus locations and details every 10 seconds (adjust the interval as needed)
                                        setInterval(updateBusLocations, 5000);
                                    }

                                    // Load the Google Maps API and initialize the map when the page has finished loading
                                    function loadMapScript() {
                                        var script = document.createElement('script');
                                        script.src =
                                            'https://maps.googleapis.com/maps/api/js?key=AIzaSyBa6oIOta-5DkFn98ubdcI6FA4h76jsDeo&callback=initMap';
                                        script.async = true;
                                        script.defer = true;
                                        document.body.appendChild(script);
                                    }

                                    loadMapScript();

                                    // Get the search input element
                                    const $searchInput = $('#searchInput');

                                    // Store the original bus data order
                                    const originalBusData = $('.form-group').clone();

                                    // Function to filter the busData based on the search query
                                    function filterBusData() {
                                        const searchQuery = $searchInput.val().toLowerCase();

                                        // Filter the original bus data based on the search query
                                        const $filteredBusData = originalBusData.filter(function () {
                                            const busName = $(this).find('.input').text().toLowerCase();
                                            const busNumber = $(this).find('li:contains("Bus Number:")').text().toLowerCase();
                                            const busOrigin = $(this).find('li:contains("Bus Origin:")').text().toLowerCase();
                                            const busDestination = $(this).find('li:contains("Bus Destination:")').text().toLowerCase();

                                            return (
                                                busName.includes(searchQuery) ||
                                                busNumber.includes(searchQuery) ||
                                                busOrigin.includes(searchQuery) ||
                                                busDestination.includes(searchQuery)
                                            );
                                        });

                                        // Clear the current bus data and append the filtered bus data
                                        $('.card-body').empty().append($filteredBusData);
                                    }

                                    // Event listener for the search input
                                    $searchInput.on('input', filterBusData);


                                    $(document).on('click', '.open-map-modal', function (event) {
                                        event.preventDefault();
                                        let busId = $(this).attr('id').trim().split('-')[2];
                                        var busName = $(this).closest('.bus-details').find('h4 a').text().trim();

                                        $('#mapModal').modal('toggle');
                                        $('#mapModalLabel').text(busName);

                                        // Get the origin and destination station from the clicked row
                                        var originStation = $(this).closest('.bus-details').find('.origin-station').text().replace('Bus Origin:', '').trim();
                                        var currentLocation = $(this).closest('.bus-details').find('li:contains("Currently at:")').text().replace('Currently at:', '').trim();
                                        var currentLocationCoords = [$(this).closest('.bus-details').find('li[data-lat]').data('lat'), $(this).closest('.bus-details').find('li[data-lng]').data('lng')]

                                        var destinationStation = $(this).closest('.bus-details').find('li:contains("Bus Destination:")').text().replace('Bus Destination:', '').trim();

                                        currentLocation = [currentLocation, currentLocationCoords]

                                        displayMapRoute(originStation, destinationStation, currentLocation);
                                    })

                                    // Method to display path between two locations

                                    function displayMapRoute(origin, destination, currentLocation) {
                                        const originCity = origin;
                                        const destinationCity = destination;

                                        const map = new google.maps.Map(document.getElementById('pathMap'), {
                                            center: { lat: 0, lng: 0 },
                                            zoom: 12
                                        });

                                        const directionsService = new google.maps.DirectionsService();
                                        const directionsRenderer = new google.maps.DirectionsRenderer({
                                            map: map
                                        });

                                        const request = {
                                            origin: originCity,
                                            destination: destinationCity,
                                            travelMode: google.maps.TravelMode.DRIVING
                                        };

                                        directionsService.route(request, function (response, status) {
                                            if (status === google.maps.DirectionsStatus.OK) {
                                                directionsRenderer.setDirections(response);

                                                // Update the map bounds to include the current location and route
                                                const bounds = new google.maps.LatLngBounds();
                                                bounds.extend(response.routes[0].bounds.getNorthEast());
                                                bounds.extend(response.routes[0].bounds.getSouthWest());
                                                map.fitBounds(bounds);
                                            } else {
                                                console.log('Error:', status);
                                            }
                                        });


                                        // Create geocoder instance
                                        const geocoder = new google.maps.Geocoder();

                                        // Geocode the current location city
                                        geocoder.geocode({ address: currentLocation[0] }, function (results, status) {
                                            if (status === google.maps.GeocoderStatus.OK && results.length > 0) {
                                                const currentLocationLatLng = results[0].geometry.location;
                                                // Create a marker for the current location city
                                                const currentLocationMarker = new google.maps.Marker({
                                                    position: currentLocationLatLng,
                                                    map: map,
                                                    icon: '/static/images/bus-icon.png',
                                                    title: 'Current Location: ' + currentLocation
                                                });

                                                // Adjust the map center to include the current location marker
                                                map.setCenter(currentLocationLatLng)
                                            } else {
                                                console.log('Error geocoding current location city:', status);
                                            }
                                        });

                                    }





                                </script>